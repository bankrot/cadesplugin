!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.AltCadesPlugin=e()}(this,function(){var t,e,n=function(t,e){return function(){return t.apply(e,arguments)}},r=[].slice;return e=null,t=function(){function t(t){return null==t&&(t={}),this.set=n(this.set,this),this.get=n(this.get,this),this.getParam=n(this.getParam,this),this.init=n(this.init,this),e?e:(t.timeout&&(this.timeout=t.timeout),this.cadesplugin.JSModuleVersion="2.0",this.cadesplugin.async_spawn=this.asyncSpawn,this.cadesplugin.set=function(t){return function(e){return t.pluginObject=e}}(this),window.cadesplugin=this.cadesplugin,void(e=this))}return t.prototype.checked=!1,t.prototype.cadesplugin={},t.prototype.pluginObject=null,t.prototype.timeout=2e4,t.prototype.isWebkit=function(){return navigator.userAgent.match(/chrome/i)||navigator.userAgent.match(/opera/i)}(),t.prototype.isIE=function(){return"Microsoft Internet Explorer"===navigator.appName||navigator.userAgent.match(/Trident\/./i)}(),t.prototype.asyncSpawn=function(t){var e,n,r,i;return e=function(t,e){var o,u,s;try{s=n[t](e)}catch(u){return o=u,Promise.reject(o)}return s.done?s.value:Promise.resolve(s.value).then(r,i)},n=t(Array.prototype.slice.call(arguments,1)),r=e.bind(e,"next"),i=e.bind(e,"throw"),r()},t.prototype.init=function(){return this.checked?$.when():this.isWebkit?this.initWebkit():this.initNpapi()},t.prototype.initWebkit=function(){var t;return t=$.Deferred(),$.getScript("chrome-extension://iifchhfnnmpdbibifmljnfjhpififfog/nmcades_plugin_api.js").done(function(t){return function(){window.postMessage("cadesplugin_echo_request","*")}}(this)).fail(function(e){return function(){return t.reject("Плагин не установлен")}}(this)),$(window).on("message",function(e){return function(e){var n;if("cadesplugin_loaded"===(null!=e&&null!=(n=e.originalEvent)?n.data:void 0))return setTimeout(function(){return cpcsp_chrome_nmcades.check_chrome_plugin(function(e){return function(){return e.checked=!0,t.resolve()}}(this),function(e){return function(n){return e.checked=!0,t.reject(n)}}(this))},0)}}(this)),setTimeout(function(e){return function(){return e.checked?void 0:t.reject("timeout")}}(this),this.timeout),t},t.prototype.initNpapi=function(){var t;return t=$.Deferred(),$(window).on("load",function(e){return function(n){var r;return e.loadNpapiPlugin(),e.checked=!0,r=e.checkNpapiPlugin(),r===!0?t.resolve():t.reject(r)}}(this)),t},t.prototype.loadNpapiPlugin=function(){var t,e;return e=$('<object id="cadesplugin_object" type="application/x-cades" style="visibility:hidden;"></object>'),$("body").append(e),this.pluginObject=e[0],this.isIE?(t=$('<object id="certEnrollClassFactory" classid="clsid:884e2049-217d-11da-b2a4-000e7bbb2b09" style="visibility:hidden;"></object>'),$("body").append(t)):void 0},t.prototype.checkNpapiPlugin=function(){var t,e,n,r;try{return this.createObject("CAdESCOM.About"),!0}catch(e){return t=e,n=navigator.mimeTypes["application/x-cades"],n?(r=n.enabledPlugin,r?"plugin_not_loaded_but_object_cannot_create":"error_on_plugin_load"):"plugin_unreachable"}},t.prototype.createObject=function(t){var e,n;if(this.isIE){if(t.match(/X509Enrollment/i))try{return $("certEnrollClassFactory")[0].CreateObject(t)}catch(n){throw e=n,"setup_https_for_x509enrollment"}return new ActiveXObject(t)}return this.pluginObject.CreateObject(t)},t.prototype.getParam=function(t,e){var n,r,i,o,u;if(n=$.Deferred(),this.isWebkit)o="string"==typeof t?this.pluginObject.CreateObjectAsync(t).then(function(t){return function(n){return e?t.extractParam(n,e):n}}(this)):this.extractParam(t,e),o.then(n.resolve,n.reject);else try{"string"==typeof t?(u=this.createObject(t),e&&(u=this.extractParam(u,e))):u=this.extractParam(t,e),n.resolve(u)}catch(i){r=i,n.reject(r.message)}return n},t.prototype.extractParam=function(t,e){if("object"!=typeof e)return t[e];switch(e.args.length){case 0:return t[e.method]();case 1:return t[e.method](e.args[0]);case 2:return t[e.method](e.args[0],e.args[1]);case 3:return t[e.method](e.args[0],e.args[1],e.args[2]);case 4:return t[e.method](e.args[0],e.args[1],e.args[2],e.args[3])}},t.prototype.get=function(){var t,e,n;return e=arguments[0],n=arguments[1],t=3<=arguments.length?r.call(arguments,2):[],this.getParam(e,n).then(function(e){return function(n){return t.length>0?(t.unshift(n),e.get.apply(e,t)):n}}(this))},t.prototype.set=function(t,e,n){var r,i,o,u;if(this.isWebkit)return u={method:"propset_"+e,args:[n]},this.get(t,u);r=$.Deferred();try{t[e]=n,r.resolve()}catch(o){i=o,r.reject(i.message)}return r},t.prototype.getVersion=function(){return $.when(this.get("CAdESCOM.About","PluginVersion","MajorVersion"),this.get("CAdESCOM.About","PluginVersion","MinorVersion"),this.get("CAdESCOM.About","PluginVersion","BuildVersion")).then(function(t,e,n){var r;return r={major:t,minor:e,build:n,full:t+"."+e+"."+n}})},t.prototype.getCSPVersion=function(){return $.when(this.get("CAdESCOM.About",{method:"CSPVersion",args:["",75]},"MajorVersion"),this.get("CAdESCOM.About",{method:"CSPVersion",args:["",75]},"MinorVersion"),this.get("CAdESCOM.About",{method:"CSPVersion",args:["",75]},"BuildVersion")).then(function(t,e,n){var r;return r={major:t,minor:e,build:n,full:t+"."+e+"."+n}})},t.prototype.getCertificates=function(){var t,e,n;return n=null,t=null,e=[],this.get("CAdESCOM.Store").then(function(t){return function(e){return n=e,t.get(n,{method:"Open",args:[]})}}(this)).then(function(t){return function(){return t.get(n,"Certificates")}}(this)).then(function(e){return function(n){return t=n,e.get(t,"Count")}}(this)).then(function(r){return function(i){var o,u;return i?(o=$.when(),$.each(function(){u=[];for(var t=1;i>=1?i>=t:t>=i;i>=1?t++:t--)u.push(t);return u}.apply(this),function(n,i){var u;return u=null,o=o.then(function(){return r.get(t,{method:"Item",args:[i]})}).then(function(t){return u=t,$.when(r.get(u,"SubjectName"),r.get(u,"IssuerName"),r.get(u,"ValidFromDate"),r.get(u,"ValidToDate"),r.get(u,{method:"PublicKey",args:[]},"Algorithm","FriendlyName"),r.get(u,{method:"HasPrivateKey",args:[]}),r.get(u,{method:"IsValid",args:[]},"Result"),r.get(u,"Thumbprint"))}).then(function(t,n,r,i,o,s,c,a){return new Date<new Date(i)&&s&&c?e.push({subject:t,issuer:n,validFrom:r,validTo:i,algorithm:o,hasPrivateKey:s,isValid:c,thumbprint:a,certificate:u}):void 0}).then(null,function(){return $.Deferred(function(){return this.reject("certificate_read_error")})})}),o):(n.Close(),$.Deferred(function(){return this.reject("certificates_not_found")}))}}(this)).then(function(t){return function(){return e.length?e:$.Deferred(function(){return this.reject("valid_certificates_not_found")})}}(this))},t.prototype.signData=function(t,e){var n,r;return r=null,n=null,this.get("CAdESCOM.CPSigner").then(function(t){return function(e){var n,i;return r=e,t.isWebkit?(n=null,i=null,t.get("CAdESCOM.CPAttribute").then(function(e){return n=e,t.set(n,"Name",0)}).then(function(){return t.set(n,"Value",new Date)}).then(function(){return t.get(r,"AuthenticatedAttributes2",{method:"Add",args:[n]})}).then(function(){return t.get("CADESCOM.CPAttribute")}).then(function(e){return i=e,t.set(i,"Name",1)}).then(function(){return t.set(i,"Value","Document Name")}).then(function(){return t.get(r,"AuthenticatedAttributes2",{method:"Add",args:[i]})})):void 0}}(this)).then(function(t){return function(){return t.set(r,"Certificate",e)}}(this)).then(function(t){return function(){return t.get("CAdESCOM.CadesSignedData")}}(this)).then(function(e){return function(r){return n=r,e.set(n,"Content",t)}}(this)).then(function(t){return function(){return t.set(r,"Options",1)}}(this)).then(function(t){return function(){return t.get(n,{method:"SignCades",args:[r,1]})}}(this)).then(function(t){return function(t){return t}}(this))},t}()});